<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡´æœ€çˆ±çš„å¸æ¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Serif+SC:wght@500&display=swap');

        body { 
            margin: 0; 
            padding: 0; 
            background-color: #000; 
            overflow: hidden; 
            font-family: 'Noto Serif SC', serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
            touch-action: none; /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨ */
        }

        /* æ˜Ÿç©ºèƒŒæ™¯ */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* é€šç”¨å®¹å™¨ */
        .container {
            text-align: center;
            position: relative;
            z-index: 10;
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            justify-content: center;
        }

        /* å¯åŠ¨æŒ‰é’® */
        .start-btn, .game-btn {
            padding: 15px 40px;
            background: linear-gradient(45deg, #ff6b8b, #ff8e53);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 107, 139, 0.6);
            animation: pulse-btn 2s infinite;
            z-index: 20;
            margin-top: 20px;
        }

        @keyframes pulse-btn {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 107, 139, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(255, 107, 139, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 107, 139, 0.6); }
        }

        /* æµªæ¼«ç¯èŠ‚å†…å®¹ */
        .romance-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 15;
        }

        /* å¤§çˆ±å¿ƒ */
        .heart-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            animation: beat 1.2s infinite;
            cursor: pointer;
        }
        
        .heart-shape {
            position: absolute;
            top: 0; left: 50px; width: 50px; height: 80px;
            background: #ff3366;
            border-radius: 50px 50px 0 0;
            transform: rotate(-45deg); transform-origin: 0 100%;
            box-shadow: 0 0 40px #ff3366;
        }
        .heart-shape:after {
            content: ""; position: absolute; top: 0; left: 0; width: 50px; height: 80px;
            background: #ff3366; border-radius: 50px 50px 0 0;
            transform: rotate(90deg); transform-origin: 0 100%;
        }

        @keyframes beat {
            0%, 28%, 70% { transform: scale(1); }
            14%, 42% { transform: scale(1.3); }
        }

        .timer { font-size: 18px; margin: 10px 0; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .timer b { font-size: 24px; color: #ff6b8b; font-family: 'Dancing Script', cursive; }
        
        .typewriter {
            font-size: 18px; line-height: 1.6; min-height: 80px;
            max-width: 90%; margin: 10px auto;
            text-shadow: 0 0 5px rgba(255,192,203,0.5);
        }

        /* --- æ¸¸æˆç›¸å…³æ ·å¼ --- */
        #game-layer {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a0b2e 0%, #2d1b4e 50%, #431228 100%);
            background-size: 200% 200%;
            animation: bg-shift 15s ease infinite;
            z-index: 100;
            flex-direction: column;
        }

        @keyframes bg-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-header {
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .resource-bar { color: #ffd700; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        
        .game-board {
            flex: 1;
            position: relative;
            overflow: hidden;
            border-top: 2px solid rgba(255,107,139,0.5);
            border-bottom: 2px solid rgba(255,107,139,0.5);
            background: rgba(0, 0, 0, 0.3);
        }

        /* æ•Œäºº */
        .enemy {
            position: absolute;
            width: 50px; height: 50px;
            font-size: 30px;
            display: flex; justify-content: center; align-items: center;
            transition: top 0.1s linear;
            z-index: 102;
        }

        /* é˜²å¾¡å¡” */
        .tower {
            position: absolute;
            width: 100%; height: 100%;
            font-size: 30px;
            display: flex; justify-content: center; align-items: center;
            z-index: 101;
            animation: bounce 0.5s;
        }

        /* å­å¼¹ */
        .bullet {
            position: absolute;
            width: 20px; height: 20px;
            background: #ff3366;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff3366;
            z-index: 103;
        }

        /* ç½‘æ ¼ç³»ç»Ÿ */
        .grid-row { display: flex; height: 16.66%; width: 100%; border-bottom: 1px dashed rgba(255,255,255,0.2); }
        .grid-cell {
            flex: 1;
            border-right: 1px dashed rgba(255,255,255,0.2);
            position: relative;
            display: flex; justify-content: center; align-items: center;
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s;
        }
        /* æ£‹ç›˜æ ¼æ•ˆæœ */
        .grid-row:nth-child(even) .grid-cell:nth-child(odd),
        .grid-row:nth-child(odd) .grid-cell:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .grid-cell.selected { background: rgba(255, 107, 139, 0.3); }

        /* åº•éƒ¨æ¤ç‰©æ  */
        .plant-bar {
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.5);
            padding-bottom: 20px; /* é€‚é…å…¨é¢å±åº•éƒ¨ */
        }

        .plant-card {
            width: 60px; height: 70px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #ccc;
            border-radius: 8px;
            display: flex; flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .plant-card.active { border-color: #ff6b8b; box-shadow: 0 0 15px #ff6b8b; background: rgba(255, 107, 139, 0.2); }
        .plant-card.disabled { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        
        .cost-tag {
            font-size: 12px; color: #ffd700;
            margin-top: 2px;
        }

        /* æ‰è½èµ„æº */
        .sun {
            position: absolute;
            font-size: 24px;
            cursor: pointer;
            animation: float-sun 3s linear infinite;
            z-index: 105;
        }

        @keyframes float-sun { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }

        /* æ¸¸æˆç»“æŸå¼¹çª— */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 200;
        }
        .modal h2 { font-size: 32px; color: #ff6b8b; margin-bottom: 20px; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .guide-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 150;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
            padding: 20px;
            pointer-events: none;
            animation: fadeOut 1s ease-in-out 3s forwards;
        }
        @keyframes fadeOut { to { opacity: 0; pointer-events: none; } }
    </style>
</head>
<body>
    <canvas id="starfield"></canvas>
    
    <!-- 1. åˆå§‹ç•Œé¢ -->
    <button class="start-btn" onclick="startRomance()">ç‚¹å‡»å¼€å¯æƒŠå–œ</button>

    <!-- éŸ³é¢‘ -->
    <audio id="bgm" loop>
        <source src="https://music.163.com/song/media/outer/url?id=1824045025.mp3" type="audio/mpeg">
    </audio>

    <!-- 2. æµªæ¼«å±•ç¤ºç•Œé¢ -->
    <div class="container" id="romance-layer">
        <div class="romance-content">
            <div class="heart-wrapper" onclick="clickHeart(event)">
                <div class="heart-shape"></div>
            </div>
            
            <div class="timer" id="timer">
                æˆ‘ä»¬ç›¸çˆ±å·²ç»ï¼š<br>
                <span id="time-count"></span>
            </div>

            <div class="typewriter" id="typewriter"></div>
            
            <!-- æ¸¸æˆå…¥å£æŒ‰é’®ï¼Œåˆå§‹éšè— -->
            <button id="enter-game-btn" class="game-btn" style="display:none; margin-top:30px;" onclick="startGame()">
                ğŸ® å¼€å¯çˆ±å¿ƒä¿å«æˆ˜
            </button>
        </div>
    </div>

    <!-- 3. æ¸¸æˆç•Œé¢ -->
    <div id="game-layer">
        <div class="game-header">
            <div class="resource-bar">â¤ï¸ <span id="love-points">100</span></div>
            <div style="color: #fff;">æ³¢æ¬¡: <span id="wave-info">1/3</span></div>
        </div>
        
        <div class="game-board" id="game-board">
            <!-- åŠ¨æ€ç”Ÿæˆç½‘æ ¼ -->
            <div class="guide-overlay" id="guide">
                <h3 style="color:#ff6b8b; font-size:24px;">çˆ±å¿ƒä¿å«æˆ˜</h3>
                <p style="color:#fff; line-height:1.5;">
                    1. ç‚¹å‡»åº•éƒ¨å¡ç‰‡é€‰æ‹©æ¤ç‰©<br>
                    2. ç‚¹å‡»æ ¼å­æ”¾ç½®é˜²å¾¡å¡”<br>
                    3. æ”¶é›†çˆ±å¿ƒâ¤ï¸è·å–èµ„æº<br>
                    4. é˜»æ­¢çƒ¦æ¼ğŸ‘¾å…¥ä¾µï¼
                </p>
            </div>
        </div>
        
        <div class="plant-bar">
            <div class="plant-card" onclick="selectPlant('shooter', 50)" id="card-shooter">
                <div style="font-size:24px">ğŸ¹</div>
                <div class="cost-tag">50</div>
            </div>
            <div class="plant-card" onclick="selectPlant('ice', 75)" id="card-ice">
                <div style="font-size:24px">ğŸ¦</div>
                <div class="cost-tag">75</div>
            </div>
            <div class="plant-card" onclick="selectPlant('wall', 50)" id="card-wall">
                <div style="font-size:24px">ğŸ›¡ï¸</div>
                <div class="cost-tag">50</div>
            </div>
             <div class="plant-card" onclick="selectPlant('bomb', 100)" id="card-bomb">
                <div style="font-size:24px">ğŸ’£</div>
                <div class="cost-tag">100</div>
            </div>
        </div>
        
        <!-- èƒœåˆ©/å¤±è´¥ å¼¹çª— -->
        <div class="modal" id="game-modal">
            <h2 id="modal-title">èƒœåˆ©!</h2>
            <p id="modal-msg" style="color:white; padding: 0 20px; text-align: center;">ä½ æˆåŠŸå®ˆæŠ¤äº†æˆ‘ä»¬çš„çˆ±ï¼</p>
            <button class="game-btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- å…¨å±€é…ç½® ---
        const START_DATE = new Date("2022-01-11");
        const LOVE_TEXT = "äº²çˆ±çš„è€å©†ï¼š\nç”Ÿæ´»ä¸­æˆ–è®¸ä¼šæœ‰\nçƒ¦æ¼å’Œå°æ€ªå…½ï¼Œ\nä½†æˆ‘ä¼šæ°¸è¿œåšä½ çš„\nä¸“å±é˜²å¾¡å¡”ï¼Œ\nå®ˆæŠ¤ä½ çš„å¼€å¿ƒä¸å¿«ä¹ï¼\n\nå‡†å¤‡å¥½ä¸€èµ·æ‰“è´¥çƒ¦æ¼äº†å—ï¼Ÿ";
        
        // --- æµªæ¼«ç¯èŠ‚é€»è¾‘ ---
        function startRomance() {
            document.querySelector('.start-btn').style.display = 'none';
            document.getElementById('romance-layer').style.display = 'flex';
            
            const audio = document.getElementById('bgm');
            audio.volume = 0.5;
            audio.play().catch(e => console.log("Audio play failed", e));

            startTimer();
            typeWriter(LOVE_TEXT, 0);
            startFallingHearts();
        }

        // è®¡æ—¶å™¨
        function startTimer() {
            function update() {
                const now = new Date();
                const diff = now - START_DATE;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('time-count').innerHTML = `<b>${days}</b>å¤© <b>${hours}</b>æ—¶ <b>${minutes}</b>åˆ† <b>${seconds}</b>ç§’`;
            }
            setInterval(update, 1000);
            update();
        }

        // æ‰“å­—æœº
        function typeWriter(text, i) {
            if (i < text.length) {
                const char = text.charAt(i);
                document.getElementById('typewriter').innerHTML += char === '\n' ? '<br>' : char;
                setTimeout(() => typeWriter(text, i + 1), 100);
            } else {
                // æ‰“å­—ç»“æŸï¼Œæ˜¾ç¤ºæ¸¸æˆæŒ‰é’®
                setTimeout(() => {
                    document.getElementById('enter-game-btn').style.display = 'block';
                }, 1000);
            }
        }

        // èƒŒæ™¯ç‰¹æ•ˆ (ç®€åŒ–ç‰ˆ)
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        let width, height;
        
        function resizeCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawStars() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#fff';
            for(let i=0; i<100; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const r = Math.random() * 1.5;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI*2);
                ctx.fill();
            }
        }
        drawStars();
        
        // é£˜è½çˆ±å¿ƒ
        function startFallingHearts() {
            setInterval(() => {
                const h = document.createElement('div');
                h.style.position = 'fixed';
                h.style.left = Math.random() * 100 + 'vw';
                h.style.top = '-10px';
                h.style.color = '#ff6b8b';
                h.innerHTML = 'â¤ï¸';
                h.style.opacity = 0.5;
                h.style.pointerEvents = 'none';
                h.style.zIndex = 5;
                h.style.transition = `top ${Math.random()*3+2}s linear, opacity 1s`;
                document.body.appendChild(h);
                setTimeout(() => { h.style.top = '105vh'; h.style.opacity = 0; }, 50);
                setTimeout(() => h.remove(), 5000);
            }, 500);
        }

        // --- æ¸¸æˆé€»è¾‘ (ç«–å±å¡”é˜²) ---
        const ROWS = 6;
        const COLS = 5;
        let gameActive = false;
        let points = 200;
        let selectedPlantType = null;
        let grid = []; // å­˜å‚¨æ ¼å­çŠ¶æ€
        let enemies = [];
        let bullets = [];
        let gameLoopId;
        let enemySpawnTimer;
        let resourceTimer;
        let wave = 1;
        const TOTAL_WAVES = 3;
        let isSpawning = false;

        function startGame() {
            document.getElementById('romance-layer').style.display = 'none';
            document.getElementById('game-layer').style.display = 'flex';
            initGrid();
            gameActive = true;
            updatePoints(0);
            
            // æ¸¸æˆå¾ªç¯
            gameLoopId = requestAnimationFrame(gameLoop);
            
            // æ•Œäººç”Ÿæˆ
            startWave(1);

            // èµ„æºè‡ªåŠ¨ç”Ÿæˆ
            resourceTimer = setInterval(() => {
                if(!gameActive) return;
                createSun();
            }, 5000);
        }

        function initGrid() {
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            grid = [];
            
            for(let r=0; r<ROWS; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'grid-row';
                let rowData = [];
                for(let c=0; c<COLS; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    cell.onclick = () => placePlant(r, c);
                    rowDiv.appendChild(cell);
                    rowData.push({ hasPlant: false, el: cell });
                }
                board.appendChild(rowDiv);
                grid.push(rowData);
            }
        }

        function selectPlant(type, cost) {
            if(points < cost) return; // é’±ä¸å¤Ÿ
            
            // ç§»é™¤æ—§é€‰æ‹©
            document.querySelectorAll('.plant-card').forEach(c => c.classList.remove('active'));
            
            if (selectedPlantType && selectedPlantType.type === type) {
                selectedPlantType = null; // å–æ¶ˆé€‰æ‹©
            } else {
                selectedPlantType = { type, cost };
                const idMap = { 'shooter': 'card-shooter', 'ice': 'card-ice', 'wall': 'card-wall', 'bomb': 'card-bomb' };
                document.getElementById(idMap[type]).classList.add('active');
            }
        }

        function placePlant(r, c) {
            if (!selectedPlantType || !gameActive) return;
            if (grid[r][c].hasPlant) return;

            // æ‰£è´¹
            updatePoints(-selectedPlantType.cost);
            
            // æ”¾ç½®è§†è§‰å…ƒç´ 
            const cell = grid[r][c].el;
            const plant = document.createElement('div');
            plant.className = 'tower';
            
            if (selectedPlantType.type === 'shooter') {
                plant.innerHTML = 'ğŸ¹';
                grid[r][c].plantObj = { type: 'shooter', hp: 100, lastShot: 0, el: plant };
            } else if (selectedPlantType.type === 'ice') {
                plant.innerHTML = 'ğŸ¦';
                grid[r][c].plantObj = { type: 'ice', hp: 100, lastShot: 0, el: plant };
            } else if (selectedPlantType.type === 'wall') {
                plant.innerHTML = 'ğŸ›¡ï¸';
                grid[r][c].plantObj = { type: 'wall', hp: 300, el: plant };
            } else if (selectedPlantType.type === 'bomb') {
                plant.innerHTML = 'ğŸ’£';
                cell.appendChild(plant);
                // ç‚¸å¼¹é€»è¾‘ï¼š1ç§’åçˆ†ç‚¸
                setTimeout(() => {
                    explode(r, c);
                    cell.innerHTML = '';
                    grid[r][c].hasPlant = false;
                }, 1000);
                grid[r][c].hasPlant = true;
                
                // é‡ç½®é€‰æ‹©
                selectedPlantType = null;
                document.querySelectorAll('.plant-card').forEach(c => c.classList.remove('active'));
                return;
            }

            cell.appendChild(plant);
            grid[r][c].hasPlant = true;

            // é‡ç½®é€‰æ‹©
            selectedPlantType = null;
            document.querySelectorAll('.plant-card').forEach(c => c.classList.remove('active'));
        }

        function explode(r, c) {
            // çˆ†ç‚¸ç‰¹æ•ˆ
            const cell = grid[r][c].el;
            const boom = document.createElement('div');
            boom.style.position = 'absolute';
            boom.style.fontSize = '50px';
            boom.innerHTML = 'ğŸ’¥';
            boom.style.zIndex = 200;
            
            // éœ‡åŠ¨ç‰¹æ•ˆ
            const board = document.getElementById('game-board');
            board.style.animation = 'shake 0.5s';
            setTimeout(() => board.style.animation = '', 500);

            // ä¿®æ­£ï¼šå°†çˆ†ç‚¸æ•ˆæœæ·»åŠ åˆ° board è€Œä¸æ˜¯ cellï¼Œé˜²æ­¢ cell è¢«æ¸…ç©ºåçœ‹ä¸åˆ°
            const rect = cell.getBoundingClientRect();
            const boardRect = document.getElementById('game-board').getBoundingClientRect();
            boom.style.left = (rect.left - boardRect.left - 10) + 'px';
            boom.style.top = (rect.top - boardRect.top - 10) + 'px';
            document.getElementById('game-board').appendChild(boom);
            
            setTimeout(() => boom.remove(), 500);

            // èŒƒå›´ä¼¤å®³ (3x3)
            for (let i = r-1; i <= r+1; i++) {
                for (let j = c-1; j <= c+1; j++) {
                     // ä¼¤å®³æ•Œäºº
                     for (let k = enemies.length - 1; k >= 0; k--) {
                        const enemy = enemies[k];
                        // ç®€å•çš„ç½‘æ ¼è·ç¦»åˆ¤æ–­
                        const er = Math.floor(enemy.y / (document.getElementById('game-board').offsetHeight / ROWS));
                        const ec = Math.floor(enemy.x / (document.getElementById('game-board').offsetWidth / COLS));
                        
                        if (Math.abs(er - i) <= 0 && Math.abs(ec - j) <= 0) { // ç®€å•åˆ¤å®šï¼šå¿…é¡»åœ¨åŒä¸€ä¸ªæ ¼å­é‡Œæˆ–è€…éå¸¸è¿‘
                             // å®é™…åº”è¯¥ç”¨åæ ‡åˆ¤æ–­ï¼Œè¿™é‡Œç®€åŒ–ä¸ºæ ¼åæ ‡
                        }
                    }
                }
            }
            
            // ç®€åŒ–ç‰ˆç‚¸å¼¹ï¼šç›´æ¥ç‚¸æ‰å…¨å±æ•Œäººï¼ˆä¸ºäº†çˆ½æ„Ÿï¼‰
            enemies.forEach(e => {
                e.hp -= 100;
                createParticle(e.x + 25, e.y + 25, 'ğŸ’¥');
            });
        }

        function updatePoints(delta) {
            points += delta;
            document.getElementById('love-points').innerText = points;
            // æ›´æ–°å¡ç‰‡çŠ¶æ€
            checkCardAffordability();
        }

        function checkCardAffordability() {
            const costs = { 'card-shooter': 50, 'card-ice': 75, 'card-wall': 50, 'card-bomb': 100 };
            for(let id in costs) {
                const el = document.getElementById(id);
                if(points < costs[id]) el.classList.add('disabled');
                else el.classList.remove('disabled');
            }
        }

        function createSun() {
            const sun = document.createElement('div');
            sun.className = 'sun';
            sun.innerHTML = 'ğŸ’–';
            const board = document.getElementById('game-board');
            sun.style.left = Math.random() * (board.offsetWidth - 40) + 'px';
            sun.style.top = '-40px';
            
            board.appendChild(sun);
            
            // é˜³å…‰ä¸‹è½åŠ¨ç”»
            let top = -40;
            const targetTop = Math.random() * (board.offsetHeight - 100) + 50;
            
            const fallInterval = setInterval(() => {
                top += 2;
                sun.style.top = top + 'px';
                if(top >= targetTop) clearInterval(fallInterval);
            }, 20);

            // ç‚¹å‡»æ”¶é›†
            sun.onclick = function() {
                updatePoints(25);
                sun.remove();
                clearInterval(fallInterval);
                createParticle(parseFloat(sun.style.left), parseFloat(sun.style.top), '+25');
            };

            // 10ç§’åæ¶ˆå¤±
            setTimeout(() => { if(sun.parentNode) sun.remove(); }, 8000);
        }

        function startWave(w) {
            wave = w;
            document.getElementById('wave-info').innerText = `${wave}/${TOTAL_WAVES}`;
            isSpawning = true;
            
            let count = 5 + wave * 3; // æ•Œäººæ•°é‡
            let spawnInterval = 2000 - wave * 300;
            
            let spawned = 0;
            enemySpawnTimer = setInterval(() => {
                if (!gameActive) return;
                spawnEnemy(wave);
                spawned++;
                if (spawned >= count) {
                    clearInterval(enemySpawnTimer);
                    enemySpawnTimer = null;
                    isSpawning = false;
                }
            }, spawnInterval);
        }

        function spawnEnemy(level) {
            const board = document.getElementById('game-board');
            const enemy = document.createElement('div');
            enemy.className = 'enemy';
            
            // æ•Œäººé…ç½®
            const enemyTypes = [
                { type: 'normal', icon: 'ğŸ‘¾', hpMod: 1, speedMod: 1 },
                { type: 'tank', icon: 'ğŸ‘¿', hpMod: 2.5, speedMod: 0.6 }, // å¦å…‹ï¼šè¡€åšæ…¢é€Ÿ
                { type: 'fast', icon: 'ğŸ•·ï¸', hpMod: 0.6, speedMod: 1.4 }, // åˆºå®¢ï¼šè¡€è–„å¿«é€Ÿ
                { type: 'boss', icon: 'ğŸ’¢', hpMod: 3, speedMod: 0.8 }    // ç²¾è‹±
            ];
            
            // éšæœºé€‰æ‹©ç±»å‹ (Bossåªåœ¨åæœŸå‡ºç°)
            let typePool = enemyTypes.slice(0, 2); // é»˜è®¤æ™®é€šå’Œå¦å…‹
            if (level >= 2) typePool = enemyTypes.slice(0, 3);
            if (level >= 3) typePool = enemyTypes;
            
            const config = typePool[Math.floor(Math.random() * typePool.length)];
            
            enemy.innerHTML = config.icon;
            
            // éšæœºåˆ—
            const col = Math.floor(Math.random() * COLS);
            const colWidth = board.offsetWidth / COLS;
            const x = col * colWidth + (colWidth - 50)/2;
            
            enemy.style.left = x + 'px';
            enemy.style.top = '-50px';
            
            board.appendChild(enemy);
            
            // åŸºç¡€æ•°å€¼
            const baseHp = 15 * level;
            const baseSpeed = 0.3 + level * 0.05; // æ•´ä½“é™é€Ÿ
            
            enemies.push({
                el: enemy,
                x: x,
                y: -50,
                hp: baseHp * config.hpMod,
                maxHp: baseHp * config.hpMod, // è®°å½•æœ€å¤§è¡€é‡ï¼Œæœªæ¥å¯åšè¡€æ¡
                speed: baseSpeed * config.speedMod,
                originalSpeed: baseSpeed * config.speedMod,
                slowTimer: 0, // å‡é€Ÿè®¡æ—¶å™¨
                col: col,
                attackCooldown: 0
            });
        }

        function checkWinCondition() {
            const checkInterval = setInterval(() => {
                if (!gameActive) { clearInterval(checkInterval); return; }
                if (enemies.length === 0 && !enemySpawnTimer) { // è¿™é‡Œçš„é€»è¾‘æœ‰ç‘•ç–µï¼Œintervalæ¸…é™¤åå˜é‡è¿˜åœ¨
                     // ç®€å•åˆ¤æ–­ï¼šå¦‚æœå½“å‰æ³¢æ¬¡æ€ªå‡ºå®Œäº†ï¼Œä¸”åœºä¸Šæ²¡æ€ªäº†
                     // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œç›´æ¥åœ¨å¾ªç¯é‡Œåˆ¤æ–­
                }
            }, 1000);
        }

        function gameLoop() {
            if (!gameActive) return;
            
            const board = document.getElementById('game-board');
            const rowHeight = board.offsetHeight / ROWS;
            
            // 1. ç§»åŠ¨æ•Œäºº
            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];
                
                // å‡é€Ÿé€»è¾‘å¤„ç†
                let currentSpeed = e.speed;
                if (e.slowTimer > 0) {
                    currentSpeed = e.originalSpeed * 0.5;
                    e.slowTimer--;
                    e.el.style.filter = 'sepia(1) hue-rotate(180deg) saturate(3)'; // å†°å†»å˜è“æ•ˆæœ
                } else {
                    e.el.style.filter = '';
                }

                e.y += currentSpeed;
                e.el.style.top = e.y + 'px';
                
                // ç¢°æ’æ£€æµ‹ï¼šæ˜¯å¦ç¢°åˆ°æ¤ç‰©
                const currentRow = Math.floor((e.y + 40) / rowHeight);
                
                if (currentRow >= 0 && currentRow < ROWS) {
                    const cell = grid[currentRow][e.col];
                    if (cell.hasPlant) {
                         // ç¢°åˆ°æ¤ç‰©ï¼Œåœæ­¢ç§»åŠ¨ï¼Œå¼€å§‹æ”»å‡»
                         e.y -= currentSpeed; // æŠµæ¶ˆç§»åŠ¨
                         e.attackCooldown++;
                         if (e.attackCooldown > 60) { // 1ç§’æ”»å‡»ä¸€æ¬¡
                             cell.plantObj.hp -= 20;
                             createParticle(e.x+25, e.y+50, 'ğŸ’¥');
                             e.attackCooldown = 0;
                             // æ¤ç‰©æ­»äº¡
                             if (cell.plantObj.hp <= 0) {
                                 cell.el.innerHTML = ''; // ç§»é™¤æ¤ç‰©å›¾æ ‡
                                 cell.hasPlant = false;
                                 cell.plantObj = null;
                             }
                         }
                    }
                }

                // æ¸¸æˆç»“æŸåˆ¤å®šï¼šåˆ°è¾¾åº•éƒ¨
                if (e.y > board.offsetHeight - 20) {
                    gameOver();
                    return;
                }
                
                // æ­»äº¡åˆ¤å®š
                if (e.hp <= 0) {
                    createParticle(e.x + 25, e.y + 25, 'âœ¨');
                    e.el.remove();
                    enemies.splice(i, 1);
                }
            }
            
            // 2. æ¤ç‰©æ”»å‡»
            const now = Date.now();
            for (let r=0; r<ROWS; r++) {
                for (let c=0; c<COLS; c++) {
                    if (grid[r][c].hasPlant) {
                        const p = grid[r][c].plantObj;
                        if (p.type === 'shooter' || p.type === 'ice') {
                            if (now - p.lastShot > 1000) { // 1ç§’ä¸€å‘
                                // æ£€æŸ¥è¯¥åˆ—æ˜¯å¦æœ‰æ•Œäºº
                                const hasEnemy = enemies.some(e => e.col === c && e.y < (r * rowHeight) && e.y > -50);
                                if (hasEnemy) {
                                    spawnBullet(r, c, p.type);
                                    p.lastShot = now;
                                }
                            }
                        }
                    }
                }
            }

            // 3. å­å¼¹ç§»åŠ¨
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                b.y -= 8; // å­å¼¹é€Ÿåº¦
                b.el.style.top = b.y + 'px';
                
                // å‡»ä¸­åˆ¤å®š
                let hit = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const e = enemies[j];
                    // ç®€å•çŸ©å½¢ç¢°æ’
                    if (Math.abs(b.x - e.x) < 30 && Math.abs(b.y - e.y) < 30) {
                        e.hp -= 10; // ä¼¤å®³
                        
                        // ç‰¹æ®Šæ•ˆæœ
                        if (b.type === 'ice') {
                            e.slowTimer = 180; // å‡é€Ÿ3ç§’ (60fps * 3)
                            createParticle(e.x+25, e.y+25, 'â„ï¸');
                        } else {
                            createParticle(e.x+25, e.y+25, 'ğŸ’¥');
                        }

                        e.el.style.transform = 'scale(1.1)';
                        setTimeout(() => e.el.style.transform = 'scale(1)', 100);
                        hit = true;
                        break;
                    }
                }
                
                if (hit || b.y < -20) {
                    b.el.remove();
                    bullets.splice(i, 1);
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        // å…¨å±€èƒœåˆ©æ£€æŸ¥å™¨
        setInterval(() => {
            if (!gameActive) return;

            // åªæœ‰å½“ä¸ç”Ÿæˆæ€ªäº†ï¼Œä¸”åœºä¸Šæ²¡æ€ªäº†ï¼Œæ‰ç®—æ³¢æ¬¡/æ¸¸æˆç»“æŸ
            if (!isSpawning && enemies.length === 0) {
                if (wave === TOTAL_WAVES) {
                    // æ¸¸æˆèƒœåˆ©
                    if (!window.victoryPending) {
                         window.victoryPending = true;
                         setTimeout(() => {
                             if (enemies.length === 0) gameWin();
                             else window.victoryPending = false;
                         }, 2000);
                    }
                } else {
                    // ä¸‹ä¸€æ³¢
                    if (!window.wavePending) {
                        window.wavePending = true;
                        setTimeout(() => {
                            startWave(wave + 1);
                            window.wavePending = false;
                        }, 2000);
                    }
                }
            }
        }, 1000);

        function spawnBullet(r, c, type) {
            const board = document.getElementById('game-board');
            const rowHeight = board.offsetHeight / ROWS;
            const colWidth = board.offsetWidth / COLS;
            
            const b = document.createElement('div');
            b.className = 'bullet';
            const x = c * colWidth + colWidth/2 - 10;
            const y = r * rowHeight + 10;
            
            b.style.left = x + 'px';
            b.style.top = y + 'px';
            
            if (type === 'ice') {
                b.style.background = '#00ffff';
                b.style.boxShadow = '0 0 10px #00ffff';
            }

            board.appendChild(b);
            
            bullets.push({ el: b, x: x, y: y, type: type });
        }

        function gameOver() {
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.getElementById('modal-title').innerText = "å†è¯•ä¸€æ¬¡";
            document.getElementById('modal-msg').innerText = "ç”Ÿæ´»çš„å°çƒ¦æ¼å¤ªå¤šå•¦ï¼Œä½†åˆ«æ”¾å¼ƒï¼Œçˆ±èƒ½æˆ˜èƒœä¸€åˆ‡ï¼";
            document.getElementById('game-modal').style.display = 'flex';
            
            // æ›¿æ¢é‡ç©æŒ‰é’®é€»è¾‘ï¼Œä¸å†åˆ·æ–°é¡µé¢
            const btn = document.querySelector('#game-modal .game-btn');
            btn.onclick = resetGame;
            btn.innerText = "é‡æ•´æ——é¼“";
        }

        function resetGame() {
            // æ¸…ç†åœºæ™¯
            document.getElementById('game-modal').style.display = 'none';
            enemies.forEach(e => e.el.remove());
            enemies = [];
            bullets.forEach(b => b.el.remove());
            bullets = [];
            document.querySelectorAll('.sun').forEach(s => s.remove());
            
            // é‡ç½®çŠ¶æ€
            points = 200;
            wave = 1;
            isSpawning = false;
            if(enemySpawnTimer) clearInterval(enemySpawnTimer);
            if(resourceTimer) clearInterval(resourceTimer);
            enemySpawnTimer = null;
            
            window.victoryPending = false;
            window.wavePending = false;

            // é‡æ–°å¼€å§‹
            initGrid();
            gameActive = true;
            updatePoints(0);
            gameLoopId = requestAnimationFrame(gameLoop);
            startWave(1);
            
            // é‡æ–°å¯åŠ¨èµ„æºç”Ÿæˆ
            resourceTimer = setInterval(() => {
                if(!gameActive) return;
                createSun();
            }, 5000);
        }

        function gameWin() {
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.getElementById('modal-title').innerText = "å®ˆæŠ¤æˆåŠŸï¼";
            document.getElementById('modal-msg').innerText = "ä½ çœŸæ£’ï¼æ‰€æœ‰çš„çƒ¦æ¼éƒ½è¢«çˆ±å¿ƒæ¶ˆç­å•¦ï¼æ°¸è¿œçˆ±ä½ ï¼";
            document.getElementById('game-modal').style.display = 'flex';
            
            // èƒœåˆ©ä¹Ÿå¯ä»¥é‡ç©
            const btn = document.querySelector('#game-modal .game-btn');
            btn.onclick = resetGame;
            btn.innerText = "å†ç©ä¸€æ¬¡";

            // èƒœåˆ©çƒŸèŠ±
            for(let i=0; i<20; i++) {
                setTimeout(() => {
                    createParticle(Math.random()*window.innerWidth, Math.random()*window.innerHeight, 'ğŸ†');
                }, i*200);
            }
        }

        // ç²’å­ç‰¹æ•ˆ
        function createParticle(x, y, char) {
            const p = document.createElement('div');
            p.style.position = 'absolute';
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            p.style.fontSize = '20px';
            p.innerHTML = char;
            p.style.pointerEvents = 'none';
            p.style.zIndex = 200;
            p.style.transition = 'all 1s ease-out';
            document.body.appendChild(p);
            
            setTimeout(() => {
                p.style.transform = `translate(${Math.random()*100-50}px, ${Math.random()*100-50}px) scale(0)`;
                p.style.opacity = 0;
            }, 10);
            setTimeout(() => p.remove(), 1000);
        }
        
        // ç‚¹å‡»çˆ±å¿ƒ
        function clickHeart(e) {
             createParticle(e.clientX, e.clientY, 'â¤ï¸');
        }

    </script>
</body>
</html>